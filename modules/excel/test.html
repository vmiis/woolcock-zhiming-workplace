<section>
    <section>
        <div id=toolbar__ID class="navbar navbar-default" style='background-color: #ccc;'>
            <span id=title__ID></span>
        </div>
        <div id=table__ID>
            <table id=grid__ID></table>
        </div>
    </section>
</section>
<script>
    function F__ID(){
        //-------------------------------
        var sheet="Information System";
        $('#D__ID').on('load',function(){  
            $vm.get_file("file",1,"file","information-system.xlsx",function(res){
                res.arrayBuffer().then( function(data){
                    var workbook = XLSX.read(data, {type:"array"});
                    workbook.SheetNames.forEach(function(sheetName) {
                        if(sheetName==sheet){
                            var jdata=XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1});
                            //console.log(jdata)
                            var txt="";
                            var J=jdata[0].length;
                            for(var i=0;i<jdata.length;i++){
                                txt+="<tr>"
                                if(i==0) txt+="<th></th>";
                                else txt+="<td>"+i+"</td>"
                                for(var j=0;j<J;j++){
                                    if(i==0) txt+="<th>"+jdata[i][j]+"</th>";
                                    else{
                                        var c="";
                                        if(j<jdata[i].length) c=jdata[i][j]
                                        txt+="<td>"+c+"</td>";
                                    }
                                }
                                txt+="</tr>";
                            }
                            $('#grid__ID').html(txt);
                        }
                    })
                })
            });
        })
        //-------------------------------
        $vm.get_file=function(table,UID,field,filename,callback){
            var get_file_from_server=function(){
                $vm.request({cmd:"file2",table:table,uid:UID,field:field,filename:filename},function(res, status, xhr){
                    if(xhr.getResponseHeader("err")=='403'){
                        alert("No permissaion.");
                        return;
                    }
                    if(xhr.getResponseHeader("err")=='404'){
                        alert("No such file.");
                        return;
                    }
                    if(xhr.getResponseHeader("err")=='604'){
                        alert("No such file!");
                        return;
                    }
                    if('caches' in window){
                        caches.open('VM').then(cache => {
                            var aHeaders = new Headers();
                            aHeaders.append('last-modifie',xhr.getResponseHeader('last-modified'));
                            var rs=new Response(res, { "headers" :aHeaders} );
                            cache.put(table+"-"+UID+"-"+field,rs);
                            return;
                        })
                    }
                    callback(res);
                });
            }
            var get_file_from_cache=function(){
                if('caches' in window){
                    caches.open('VM').then(
                        cache => {
                            cache.match(table+"-"+UID+"-"+field).then(response => {
                                if(response){
                                    $vm.request({cmd:"file2",table:table,uid:UID,field:field,filename:filename,datetime:1},function(res){
                                        if(res.status=="np"){
                                            alert("No permissaion.");
                                            return;
                                        };
                                        var dtA=new Date(response.headers.get('last-modifie')).getTime();
                                        var dtB=new Date(res.result).getTime();
                                        dtA=dtA-dtA%1000;
                                        dtB=dtB-dtB%1000;
                                        if(dtA==dtB){
                                            callback(response);
                                        }
                                        else get_file_from_server();
                                    })
                                }
                                else{
                                    get_file_from_server();
                                }
                            })
                        }
                    )
                }
            }
            get_file_from_cache();
        }
        //-------------------------------




$vm.request=function(req,callback,progress){
    $vm.sys_N++;
    var this_N=$vm.sys_N;
    $vm.sys_token="guest|where|when|scode";
    if($vm.debug_message===true){
        console.log("%c"+req.cmd+'('+this_N+') TO ',"color:orange",req);
    }
    var dt1=new Date().getTime();
    $vm.ajax_server_error=0;
    var token=sessionStorage.getItem("vm_token");
    if(token==undefined) token="";
    
    var param={
        headers:{'Authorization':'Bearer ' + token},
        type: "POST",
        url: $vm.api_address,
        contentType: "application/json",
        charset:"utf-8",
        dataType: "json",
        error: function(jqXHR, error, errorThrown){ 
            if(error && (req.cmd=='file' || req.cmd=='file2')){
                callback(404);
            }
            if(jqXHR.status) {} 
            else {}},
        data: JSON.stringify(req),
        success: function(c,textStatus, request){
            var dt2=new Date().getTime();
            if($vm.debug_message===true){
                if(c.status=='ok' || req.cmd=='file')  console.log("%c"+req.cmd+'('+this_N+') FROM'+" --- "+(dt2-dt1).toString()+"ms","color:lightgreen",c);
                else                                   console.log("%c"+req.cmd+'('+this_N+') FROM'+" --- "+(dt2-dt1).toString()+"ms","color:red",c);
            }
            if($vm.ajax_server_error==1) return;
            try{
                if(callback!==undefined) callback(c,textStatus, request);
            }catch(err){
                alert(err.toString());
            }
        },
        dataFilter: $vm.request_filter,
    }
    if(progress!=undefined){
        param.xhr=function(){
            var xhr = $.ajaxSettings.xhr() ;
            xhr.upload.onprogress = function(evt){ progress(evt.loaded, evt.total); } ;
            xhr.upload.onload = function(){ } ;
            return xhr ;
        }
    }
    if(req.cmd=="export"){
        param.xhr=function(){
            var i=1;
            var xhr = new window.XMLHttpRequest();
            xhr.addEventListener("progress", function(evt){
                var N=-1,end="";
                var len=xhr.responseText.length;
                if(len>=5 && N==-1)  N=parseInt(xhr.responseText.substring(0,5));
                if(len>=14) end=xhr.responseText.substring(len-9,len);
                if(end=='__E_N_D__') i=-1;
                callback(N,i,xhr.responseText);
                i++;
            }, false);
            return xhr;
        }
    }
    else if( (req.cmd=="file" || req.cmd=="file2") && req.datetime==undefined ){
        delete param.dataType;
        param.xhrFields={responseType: 'blob'};
    }
    $.ajax(param)
};
//-----------------------------------------------------------------





    }
</script>
<style>
    VmInclude:__COMPONENT__/g/grid.01.css
</style>
